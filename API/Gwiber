local version = "1.04"

local moveFn = {}
local attackFn = {}
local digFn = {}
local digEnchant = {}
local detectFn = {}
local inspectFn = {}
local suckFn = {}
local dropFn = {}
local enchant = nil
local configData

function init(turtle)
  if (turtle == nil) then return end
  moveFn[direction.FORWARD] = turtle.forward
  moveFn[direction.DOWN] = turtle.down
  moveFn[direction.UP] = turtle.up
  attackFn[direction.FORWARD] = turtle.attack
  attackFn[direction.DOWN] = turtle.attackDown
  attackFn[direction.UP] = turtle.attackUp
  digFn[direction.FORWARD] = turtle.dig
  digFn[direction.DOWN] = turtle.digDown
  digFn[direction.UP] = turtle.digUp
  digEnchant[direction.FORWARD] = turtle.dig
  digEnchant[direction.DOWN] = turtle.digDown
  digEnchant[direction.UP] = turtle.digUp
  detectFn[direction.FORWARD] = turtle.detect
  detectFn[direction.DOWN] = turtle.detectDown
  detectFn[direction.UP] = turtle.detectUp
  inspectFn[direction.FORWARD] = turtle.inspect
  inspectFn[direction.DOWN] = turtle.inspectDown
  inspectFn[direction.UP] = turtle.inspectUp
  suckFn[direction.FORWARD] = turtle.suck
  suckFn[direction.DOWN] = turtle.suckDown
  suckFn[direction.UP] = turtle.suckUp
  dropFn[direction.FORWARD] = turtle.drop
  dropFn[direction.DOWN] = turtle.dropDown
  dropFn[direction.UP] = turtle.dropUp
  dofile(configData)
  checkEnchant()
end

function setPath(name)
  configData = "/config/"..name.."_config"
end

function checkEnchant()
  local var = peripheral.getNames()
  local program
  for i = 1, #var do
    local pmnames = peripheral.getMethods(var[i])
    program = peripheral.wrap(var[i])
    -- More Turtles 2.0.0à»ëO
    if (pmnames ~= nil and pmnames[1] == "digSilkTouch") then
      digEnchant[direction.FORWARD] = program.digSilkTouch
      digEnchant[direction.DOWN] = program.digSilkTouchDown
      digEnchant[direction.UP] = program.digSilkTouchUp
      enchant = "SilkTouch"
      return
    end
    if (pmnames ~= nil and pmnames[1] == "digFortune") then
      digEnchant[direction.FORWARD] = program.digFortune
      digEnchant[direction.DOWN] = program.digFortuneDown
      digEnchant[direction.UP] = program.digFortuneUp
      enchant = "Fortune"
      return
    end
    -- More Turtles 2.0.0à»ç~
    program = peripheral.wrap(var[i])
    if (program.getName ~= nil) then
      local name = program.getName()
      if (name == "SilkTouch") then
        digEnchant[direction.FORWARD] = program.dig
        digEnchant[direction.DOWN] = program.digDown
        digEnchant[direction.UP] = program.digUp
        enchant = "SilkTouch"
        return
      end
      if (name == "Fortune") then
        digEnchant[direction.FORWARD] = program.dig
        digEnchant[direction.DOWN] = program.digDown
        digEnchant[direction.UP] = program.digUp
        enchant = "Fortune"
        return
      end
    end
  end
end

function getEnchantName()
  return enchant
end

function move(dir)
  local doMove = false
  local iFlag, iData = inspectFn[dir]()
  local dFlag = detect(dir)
  repeat
    if (iFlag and dFlag) then
      digSuccess = digTurtle(dir, iData)
      if (not digSuccess) then break end
    elseif (iFlag and iData.metadata == 0) then
      if (not isContains(iData, table2)) then break end
    end
    doMove = moveFn[dir]()
    if (not doMove) then
      attackFn[dir]()
    end
  until (doMove)
  return doMove
end

function digTurtle(dir, iData)
  if (isContains(iData, table1)) then return false end
  if (isContains(iData, table3)) then 
    return digEnchant[dir]()
  end
  return digFn[dir]()
end

function getInspect(dir)
  local iFlag, iData = inspectFn[dir]()
  return iData
end

function dig(dir)
  local iData = getInspect(dir)
  return digTurtle(dir, iData)
end

function detect(dir)
  return detectFn[dir]()
end

function inspect(dir)
  return inspectFn[dir]()
end

function suck(dir)
  return suckFn[dir]()
end

function drop(dir)
  return dropFn[dir]()
end

function isContains(var, table)
  if (var == nil) then return false end
  for i = 1, #table.list do
  local lb = table.list[i][1]
  local lm = table.list[i][2]
    if (var.name == lb) then
      if (lm == nil) then
        return table.isWhite
      else
        for j = 1, #lm do
          if (var.meta == lm[j]) then
            return table.isWhite
          end
        end
      end
    end
  end
  return (not table.isWhite)
end

dofile("/util/util")
checkEnchant()